import streamlit as st
import time
import random
from datetime import datetime

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="ä¸­è¥¿åŒ»ååŒâ€œæ——èˆ°â€åŒ»é™¢Â·ä¿¡æ¯åŒ–è¿›å±•",
    page_icon="ğŸ¥",
    layout="wide"
)

# åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
if "projects" not in st.session_state:
    st.session_state.projects = [
        {"name": "ä¸­åŒ»æ™ºèƒ½ä¸´åºŠè¾…åŠ©è¯Šç–—ç³»ç»Ÿ", "progress": 54, "last_update": "10:31"},
        {"name": "è¡€æ¶²é€æç®¡ç†è½¯ä»¶ç³»ç»Ÿ", "progress": 60, "last_update": "10:33"},
        {"name": "ä¸´åºŠè¯•éªŒä¿¡æ¯åŒ–ç³»ç»Ÿï¼ˆäºŒæœŸï¼‰", "progress": 83, "last_update": "10:32"},
        {"name": "PACSç³»ç»Ÿæ›´æ–°æ”¹é€ ", "progress": 79, "last_update": "10:30"},
        {"name": "ä½“å¾æ™ºèƒ½é‡‡é›†ç³»ç»Ÿ", "progress": 16, "last_update": "10:32"},
        {"name": "è¾“æ¶²ç›‘æŠ¤ç®¡ç†ç³»ç»Ÿ", "progress": 59, "last_update": "10:32"},
        {"name": "åŒæ´»æ•°æ®ä¸­å¿ƒå®¹ç¾å¤‡ä»½ç³»ç»Ÿå»ºè®¾", "progress": 76, "last_update": "10:32"},
        {"name": "åŒ»ç–—AIé‡‡è´­é¡¹ç›®", "progress": 22, "last_update": "10:32"},
    ]

if "activity_log" not in st.session_state:
    st.session_state.activity_log = [
        "10:33 âœ… â€œè¡€æ¶²é€æç®¡ç†è½¯ä»¶ç³»ç»Ÿâ€è¿›åº¦æ›´æ–° 55% â†’ 60%",
        "10:32 âœ… â€œè¾“æ¶²ç›‘æŠ¤ç®¡ç†ç³»ç»Ÿâ€è¿›åº¦æ›´æ–° 53% â†’ 59%",
        "10:32 âœ… â€œä¸´åºŠè¯•éªŒä¿¡æ¯åŒ–ç³»ç»Ÿï¼ˆäºŒæœŸï¼‰â€è¿›åº¦æ›´æ–° 79% â†’ 83%",
        "10:32 âœ… â€œåŒ»ç–—AIé‡‡è´­é¡¹ç›®â€è¿›åº¦æ›´æ–° 19% â†’ 22%",
        "10:32 âœ… â€œè¡€æ¶²é€æç®¡ç†è½¯ä»¶ç³»ç»Ÿâ€è¿›åº¦æ›´æ–° 49% â†’ 55%",
        "10:32 âœ… â€œä½“å¾æ™ºèƒ½é‡‡é›†ç³»ç»Ÿâ€è¿›åº¦æ›´æ–° 15% â†’ 16%",
    ]

# æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°å‡½æ•°
def simulate_progress_update():
    # éšæœºé€‰æ‹©1-2ä¸ªé¡¹ç›®è¿›è¡Œæ›´æ–°
    num_updates = random.randint(1, 2)
    selected_indices = random.sample(range(len(st.session_state.projects)), num_updates)
    
    for i in selected_indices:
        old_progress = st.session_state.projects[i]["progress"]
        # æ¯æ¬¡æ›´æ–°1-3ä¸ªç™¾åˆ†ç‚¹ï¼Œä¸è¶…è¿‡100%
        new_progress = min(old_progress + random.randint(1, 3), 100)
        st.session_state.projects[i]["progress"] = new_progress
        
        # æ›´æ–°æ—¶é—´
        current_time = datetime.now().strftime("%H:%M")
        st.session_state.projects[i]["last_update"] = current_time
        
        # æ·»åŠ åˆ°æ´»åŠ¨æ—¥å¿—
        log_entry = f"{current_time} âœ… â€œ{st.session_state.projects[i]['name']}â€è¿›åº¦æ›´æ–° {old_progress}% â†’ {new_progress}%"
        st.session_state.activity_log.insert(0, log_entry)

# æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯
st.title("ä¸­è¥¿åŒ»ååŒâ€œæ——èˆ°â€åŒ»é™¢Â·ä¿¡æ¯åŒ–è¿›å±•")
st.markdown("**è¥¿å®‰äº¤é€šå¤§å­¦ç¬¬äºŒé™„å±åŒ»é™¢** | è¯•ç‚¹é¡¹ç›® Â· 8ä¸ªå­é¡¹")

# é¡¶éƒ¨æ¦‚è§ˆåŒº
col1, col2, col3 = st.columns(3)
with col1:
    st.metric("å­é¡¹ç›®æ€»æ•°", "8")
with col2:
    st.metric("å·²å®Œæˆ", "0")
with col3:
    total_progress = sum(p["progress"] for p in st.session_state.projects) / len(st.session_state.projects)
    st.metric("æ€»ä½“è¿›åº¦", f"{total_progress:.0f}%", delta=f"è¿›è¡Œä¸­: 8 | å¾…å¼€å§‹: 0")

st.divider()

# å·¦ä¾§ï¼šå­é¡¹ç›®è¿›åº¦è·Ÿè¸ª
col_left, col_right = st.columns([2, 1])

with col_left:
    st.subheader("å­é¡¹ç›®è¿›åº¦è·Ÿè¸ª")
    st.caption("åŠ¨æ€æ¨¡æ‹Ÿä¸­")
    
    for p in st.session_state.projects:
        col_proj, col_bar, col_status, col_time = st.columns([3, 2, 1, 1])
        with col_proj:
            st.markdown(f"**{p['name']}**")
        with col_bar:
            st.progress(p["progress"] / 100)
        with col_status:
            st.markdown("è¿›è¡Œä¸­")
        with col_time:
            st.markdown(p["last_update"])

# å³ä¾§ï¼šå…³é”®é¢†åŸŸè¿›åº¦ + å®æ—¶åŠ¨æ€
with col_right:
    # å…³é”®é¢†åŸŸè¿›åº¦
    st.subheader("å…³é”®é¢†åŸŸè¿›åº¦")
    domain_map = {
        "ä¸­åŒ»è¾…åŠ©è¯Šç–—": "ä¸­åŒ»æ™ºèƒ½ä¸´åºŠè¾…åŠ©è¯Šç–—ç³»ç»Ÿ",
        "è¡€æ¶²ç®¡ç†": "è¡€æ¶²é€æç®¡ç†è½¯ä»¶ç³»ç»Ÿ",
        "ä¸´åºŠè¯•éªŒ(äºŒæœŸ)": "ä¸´åºŠè¯•éªŒä¿¡æ¯åŒ–ç³»ç»Ÿï¼ˆäºŒæœŸï¼‰",
        "PACSæ›´æ–°": "PACSç³»ç»Ÿæ›´æ–°æ”¹é€ ",
        "å®¹ç¾å¤‡ä»½": "åŒæ´»æ•°æ®ä¸­å¿ƒå®¹ç¾å¤‡ä»½ç³»ç»Ÿå»ºè®¾"
    }
    
    for domain, proj_name in domain_map.items():
        proj = next(p for p in st.session_state.projects if p["name"] == proj_name)
        col_dom, col_dom_bar, col_dom_pct = st.columns([2, 3, 1])
        with col_dom:
            st.markdown(f"**{domain}**")
        with col_dom_bar:
            st.progress(proj["progress"] / 100)
        with col_dom_pct:
            st.markdown(f"{proj['progress']}%")
    
    st.divider()
    
    # å®æ—¶åŠ¨æ€
    st.subheader("å®æ—¶åŠ¨æ€")
    for log in st.session_state.activity_log[:10]:  # åªæ˜¾ç¤ºæœ€è¿‘10æ¡
        st.markdown(log)
    
    st.button("æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°", on_click=simulate_progress_update)

# é¡µè„š
st.caption("æ¯8ç§’è‡ªåŠ¨æ¨¡æ‹Ÿå­é¡¹ç›®è¿›å±•")

# è‡ªåŠ¨åˆ·æ–°é€»è¾‘
if st.button("å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯8ç§’ï¼‰"):
    while True:
        simulate_progress_update()
        time.sleep(8)
        st.rerun()
